<html>
  <head>
    <style>
      .padding-20 {
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div id="main_container"></div>
    <script>
      const ReactInnerContext = {
        elementId: 0,
        activeId: null,
        stateMap: {},
        renderTreeCreator: null,
        processedRenderTree: null,
        reactRootTreeElement: null,
        targetElement: null
      };

      function requestStateUpdateFor(elementId) {
        renderRoot(ReactInnerContext.renderTreeCreator, ReactInnerContext.targetElement, true);
      }

      function useState(initialState) {
        const activeElementId = ReactInnerContext.activeId;

        if (typeof ReactInnerContext.stateMap[activeElementId] === "undefined") {
          ReactInnerContext.stateMap[activeElementId] = initialState;
        }

        const stateUpdater = function (newState) {
          ReactInnerContext.stateMap[activeElementId] = newState;
          setTimeout(function () {
            // TODO: Find a better id resolution..
            requestStateUpdateFor(activeElementId);
          }, 50);
        };

        return [ReactInnerContext.stateMap[activeElementId], stateUpdater];
      }

      function createElement(typeOrFunction, props, children) {
        let renderTree = {
          $$id: `element-${ReactInnerContext.elementId++}`,
          type: typeOrFunction,
          props: props,
          children: null,
          $$nativeElement: null // will be filled later
        };

        if (typeof typeOrFunction === "function") {
          ReactInnerContext.activeId = renderTree.$$id;
          renderTree.children = typeOrFunction(props, children);
        } else {
          renderTree.children = children;
        }

        return renderTree;
      }

      function removeAllChildNodes(parent) {
        while (parent.firstChild) {
          parent.removeChild(parent.firstChild);
        }
      }

      function renderRoot(renderTreeCreator, targetElement, replacePreviousRoot) {
        // this is
        ReactInnerContext.activeId = -1;
        ReactInnerContext.elementId = 0;

        const processedRenderTree = renderTreeCreator();

        const reactRootTreeElement = document.createDocumentFragment();

        renderNode(processedRenderTree, reactRootTreeElement);

        if (replacePreviousRoot) {
          removeAllChildNodes(targetElement);
        }

        targetElement.appendChild(reactRootTreeElement);

        ReactInnerContext.reactRootTreeElement = reactRootTreeElement;
        ReactInnerContext.renderTreeCreator = renderTreeCreator;
        ReactInnerContext.processedRenderTree = processedRenderTree;
        ReactInnerContext.targetElement = targetElement;
      }

      // simple tree traversal
      function renderNode(node, parentElement) {
        if (node === null || node === undefined) {
          return;
        }

        if (typeof node.type !== "function") {
          const activeNode = document.createElement(node.type);
          activeNode.className = node?.props?.className;

          if (node.props?.__innerHTML) {
            activeNode.innerHTML = node.props?.__innerHTML;
          }

          node.$$nativeElement = activeNode;

          if (node.props?.events) {
            Object.keys(node.props?.events).forEach((key) => {
              activeNode.addEventListener(key, function (evt) {
                node.props?.events[key]?.(evt);
              });
            });
          }

          parentElement.appendChild(activeNode);

          renderNode(node.children, activeNode);
        } else {
          renderNode(node.children, parentElement);
        }
      }

      /// ----- Greeting.js
      function Greeting({ name }) {
        const [enabled, setEnabled] = useState(false);
        console.log("enabled", enabled);

        if (enabled) {
          return createElement("div", { className: "padding-20", __innerHTML: "Content removed" });
        }

        return createElement(
          "h1",
          { className: "greeting" },
          createElement(
            "button",
            {
              className: "btn-primary",
              events: {
                click: (evt) => {
                  setEnabled(true);
                  console.log("onclick");
                }
              }
            },
            createElement("span", { __innerHTML: `Do you want to re-render ${name}?`})
          )
        );
      }

      /// ---- App.js
      function App() {
        return createElement("div", { className: "padding-20", __innerHTML: "Root div" }, createElement(Greeting, { name: "Tayfun" }));
      }

      /// ------ index.js
      // import App from "./App.js";
      // import { renderRoot } from "./react.js";

      const renderTreeCreator = () => App();

      console.log(JSON.stringify(renderTreeCreator()));

      renderRoot(renderTreeCreator, document.getElementById("main_container"));
    </script>
  </body>
</html>
